l{% extends 'base.html' %}
{% load static %}
{% load schedule_tags %}

{% block title %}Mark Attendance - {{ occurrence.date }}{% endblock %}

{% block content %}
    <div class="container py-5">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Mark Attendance</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>{{ occurrence.schedule.group.name }}</strong>
                            - {{ occurrence.schedule.group.course.name }}<br>
                            <strong>Date:</strong> {{ occurrence.date|date:"l, F d, Y" }}<br>
                            <strong>Time:</strong> {{ occurrence.schedule.start_time }}
                            - {{ occurrence.schedule.end_time }}
                        </div>

                        {% if not occurrence.is_cancelled %}
                            <form method="post">
                                {% csrf_token %}
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead class="table-light">
                                        <tr>
                                            <th>Student</th>
                                            <th>Status</th>
                                            <th>Notes</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for enrollment in enrollments %}
                                            {% with attendance=attendance_records|get_item:enrollment.student.id %}
                                                <tr>
                                                    <td>
                                                        <strong>{{ enrollment.student.user.get_full_name|default:enrollment.student.user.username }}</strong><br>
                                                        <small class="text-muted">{{ enrollment.student.user.email }}</small>
                                                    </td>
                                                    <td>
                                                        <select name="status_{{ enrollment.student.id }}"
                                                                class="form-select" required>
                                                            <option value="">-- Select Status --</option>
                                                            <option value="present"
                                                                    {% if attendance.status == 'present' %}selected{% endif %}>
                                                                Present
                                                            </option>
                                                            <option value="absent"
                                                                    {% if attendance.status == 'absent' %}selected{% endif %}>
                                                                Absent
                                                            </option>
                                                            <option value="late"
                                                                    {% if attendance.status == 'late' %}selected{% endif %}>
                                                                Late
                                                            </option>
                                                            <option value="excused"
                                                                    {% if attendance.status == 'excused' %}selected{% endif %}>
                                                                Excused
                                                            </option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <textarea name="notes_{{ enrollment.student.id }}"
                                                                  class="form-control form-control-sm" rows="1"
                                                                  placeholder="Optional notes">{% if attendance %}
                                                            {{ attendance.notes }}{% endif %}</textarea>
                                                    </td>
                                                </tr>
                                            {% endwith %}
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <div class="d-flex gap-2 mt-4">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fas fa-save"></i> Save Attendance
                                    </button>
                                    <a href="{% url 'attendance:schedule_list' %}" class="btn btn-secondary btn-lg">
                                        <i class="fas fa-arrow-left"></i> Back
                                    </a>
                                </div>
                            </form>
                        {% else %}
                            <div class="alert alert-warning">
                                <strong>This class has been cancelled.</strong> Attendance cannot be marked.
                            </div>
                            <a href="{% url 'attendance:schedule_list' %}" class="btn btn-secondary">Back to
                                Schedule</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Custom template filter helper for dictionary get
        // Note: You'll need to add a custom template filter for this
    </script>
{% endblock %}

