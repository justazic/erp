{% extends "base.html" %}

{% block title %}{% if session %}Edit{% else %}Create{% endif %} Session | TOTC{% endblock %}

{% block content %}
    <section class="section section--soft">
        <div class="container">
            <div class="center" style="margin-bottom: 48px;">
                <h2 class="h2">{% if session %}Edit{% else %}Create New{% endif %} <span class="accent">Session</span></h2>
                <p class="muted">Define a new academic session for a course.</p>
            </div>

            <div style="max-width: 800px; margin: 0 auto;">
                <form method="post" class="card" style="background: #fff; padding: 40px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 32px;">
                    {% csrf_token %}
                    <input type="hidden" name="update_session" value="1">

                    <div style="margin-bottom: 24px;">
                        <label class="small" style="display: block; margin-bottom: 8px; font-weight: 600;">Course</label>
                        <select name="course" required style="width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit;">
                            <option value="">-- Select Course --</option>
                            {% for course in courses %}
                                <option value="{{ course.id }}" {% if session.course_id == course.id %}selected{% endif %}>{{ course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label class="small" style="display: block; margin-bottom: 8px; font-weight: 600;">Session Type</label>
                        <select name="session_type" required style="width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit;">
                            <option value="1st" {% if session.session_type == '1st' %}selected{% endif %}>1st Session</option>
                            <option value="2nd" {% if session.session_type == '2nd' %}selected{% endif %}>2nd Session</option>
                            <option value="3rd" {% if session.session_type == '3rd' %}selected{% endif %}>3rd Session</option>
                            <option value="4th" {% if session.session_type == '4th' %}selected{% endif %}>4th Session</option>
                            <option value="spring" {% if session.session_type == 'spring' %}selected{% endif %}>Spring</option>
                            <option value="summer" {% if session.session_type == 'summer' %}selected{% endif %}>Summer</option>
                            <option value="fall" {% if session.session_type == 'fall' %}selected{% endif %}>Fall</option>
                            <option value="winter" {% if session.session_type == 'winter' %}selected{% endif %}>Winter</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                        <div>
                            <label class="small" style="display: block; margin-bottom: 8px; font-weight: 600;">Start Date</label>
                            <input type="date" name="start_date" value="{{ session.start_date|date:'Y-m-d' }}" required 
                                   style="width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit;">
                        </div>
                        <div>
                            <label class="small" style="display: block; margin-bottom: 8px; font-weight: 600;">End Date</label>
                            <input type="date" name="end_date" value="{{ session.end_date|date:'Y-m-d' }}" required 
                                   style="width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit;">
                        </div>
                    </div>

                    <div style="margin-bottom: 32px;">
                        <label class="small" style="display: block; margin-bottom: 8px; font-weight: 600;">Capacity</label>
                        <input type="number" name="capacity" value="{{ session.capacity|default:30 }}" required 
                               style="width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit;">
                    </div>

                    <div style="display: flex; gap: 16px;">
                        <button type="submit" class="btn btn--pill btn--primary" style="flex: 1;">{% if session %}Update{% else %}Create{% endif %} Session</button>
                        <a href="{% url 'courses:admin_dashboard' %}" class="btn btn--pill btn--white" style="flex: 1; border: 1px solid #ddd;">Cancel</a>
                    </div>
                </form>

                {% if session %}
                    <div class="dashGrid" style="grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 40px;">
                        <!-- Groups in this Session -->
                        <div class="dashCard">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 class="dashCard__title" style="margin: 0;">Groups in Session</h3>
                                <a href="{% url 'courses:group_create' %}?course={{ session.course.id }}&session={{ session.id }}" class="btn btn--pill btn--outlineTeal btn--small">+ New</a>
                            </div>
                            <ul class="dashList">
                                {% for group in groups %}
                                    <li class="dashList__item">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div class="dashList__main">{{ group.name }}</div>
                                                <div class="dashList__sub tiny muted">{{ group.teacher.get_full_name }} â€¢ {{ group.student_count }} Students</div>
                                            </div>
                                            <a href="{% url 'courses:admin_group_students' group.id %}" class="btn btn--pill btn--primary btn--small">Students</a>
                                        </div>
                                    </li>
                                {% empty %}
                                    <li class="dashList__item">No groups in this session.</li>
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- Add Student to Session -->
                        <div class="dashCard">
                            <h3 class="dashCard__title">Assign Student to Session</h3>
                            <form method="post" style="margin-bottom: 24px;">
                                {% csrf_token %}
                                <input type="hidden" name="assign_student" value="1">
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" id="student-search" placeholder="Search students..." 
                                           style="flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ddd; font-size: 14px;"
                                           onkeyup="searchStudents(this.value)">
                                </div>
                                <div id="search-results" style="margin-top: 12px; max-height: 200px; overflow-y: auto; background: #f9f9f9; border-radius: 10px;">
                                    <!-- Results will appear here -->
                                </div>
                            </form>
                            
                            <h3 class="dashCard__title">Enrolled Students ({{ session_students.count }})</h3>
                            <ul class="dashList" style="max-height: 300px; overflow-y: auto;">
                                {% for enrollment in session_students %}
                                    <li class="dashList__item">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div class="dashList__main">{{ enrollment.student.get_full_name|default:enrollment.student.username }}</div>
                                                <div class="dashList__sub tiny muted">
                                                    {% if enrollment.group %}
                                                        Group: {{ enrollment.group.name }}
                                                    {% else %}
                                                        <span style="color: var(--pink);">No Group Assigned</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <form method="post" onsubmit="return confirm('Remove student from this session?')">
                                                {% csrf_token %}
                                                <input type="hidden" name="remove_student" value="1">
                                                <input type="hidden" name="student_id" value="{{ enrollment.student.id }}">
                                                <button type="submit" class="tiny link" style="color: var(--pink); border: none; background: none; cursor: pointer;">Remove</button>
                                            </form>
                                        </div>
                                    </li>
                                {% empty %}
                                    <li class="dashList__item">No students in this session.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <script>
                        async function searchStudents(query) {
                            if (query.length < 2) {
                                document.getElementById('search-results').innerHTML = '';
                                return;
                            }
                            
                            // Using the existing student list view with JSON if possible, but let's just use a simple fetch
                            const response = await fetch(`/admin/students/?search=${query}`);
                            const html = await response.text();
                            
                            // Parse HTML to find students
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const studentRows = doc.querySelectorAll('.dashList__item');
                            
                            let resultsHtml = '';
                            studentRows.forEach(row => {
                                const name = row.querySelector('.dashList__main').textContent;
                                const id = row.querySelector('a').href.split('/').filter(Boolean).pop();
                                
                                resultsHtml += `
                                    <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                        <span class="small">${name}</span>
                                        <form method="post">
                                            {% csrf_token %}
                                            <input type="hidden" name="assign_student" value="1">
                                            <input type="hidden" name="student_id" value="${id}">
                                            <button type="submit" class="btn btn--pill btn--primary btn--small" style="font-size: 10px; padding: 4px 8px;">Assign</button>
                                        </form>
                                    </div>
                                `;
                            });
                            
                            document.getElementById('search-results').innerHTML = resultsHtml || '<div style="padding:10px;" class="tiny muted">No students found</div>';
                        }
                    </script>
                {% endif %}
            </div>
        </div>
    </section>
{% endblock %}
